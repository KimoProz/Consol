<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مشغل فيديو جماعي</title>
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:sans-serif;overflow:hidden;background:#000;color:#fff;} 
        .flex{display:flex;} 
        .center{justify-content:center;align-items:center;} 
        .column{flex-direction:column;} 
        input,button{padding:10px;border-radius:8px;border:none;margin:5px;} 
        button{background:#2ea6ff;color:#000;font-weight:700;cursor:pointer;transition:0.2s;} 
        button:hover{transform:scale(1.05);} 
        #loginPage,#createPage,#playerPage{height:100%;width:100%;position:absolute;top:0;left:0;} 
        #playerPage{display:none;flex-direction:column;position:relative;} 
        video{width:100%;height:100%;object-fit:contain;background:#000;transition:0.3s;} 
        
        /* floating */
        #floating{ 
            position:fixed; 
            top:20px; 
            left:20px; 
            width:220px; /* تم تصغير الحجم */
            height:260px; /* تم تصغير الحجم */
            background:rgba(30,30,30,0.85); 
            backdrop-filter:blur(12px); 
            border-radius:12px; 
            z-index:999; 
            display:flex; 
            flex-direction:column; 
            box-shadow:0 0 20px rgba(0,0,0,0.8); 
            touch-action:none; 
            border: 1px solid rgba(255,255,255,0.15);
            animation: floatIn 0.5s ease-out;
        } 
        #floatingHeader{background:rgba(0,0,0,0.35);padding:8px;text-align:center;font-size:13px;user-select:none;display:flex;justify-content:space-between;align-items:center;cursor:grab;border-top-left-radius:12px;border-top-right-radius:12px;} 
        #floatingTitle{flex:1;text-align:center;} 
        #headerBtns{display:flex;gap:4px;} 
        .headerBtn{padding:0 6px;cursor:pointer;background:transparent;border-radius:6px;transition:0.2s;}
        .headerBtn:hover{background:rgba(255,255,255,0.1);} 
        #chatMessages{flex:1;overflow-y:auto;padding:8px;font-size:13px;transition:0.2s;border-bottom:1px solid rgba(255,255,255,0.05);} 
        #chatMessages div{margin-bottom:6px;opacity:0;animation:fadeIn 0.3s forwards;} 
        #chatInputContainer{display:flex;flex-direction:column;padding:6px;gap:6px;} 
        /* تصميم جديد لمربع الإدخال مع زر مدمج */
        #chatRow{display:flex; position: relative; width: 100%;}
        #chatInput{border-radius:8px;padding:10px;border:none;height:40px;box-sizing:border-box; width: 100%; padding-right: 70px; background: rgba(255,255,255,0.12); color: white; transition:0.2s;} 
        #chatInput:focus{outline:none; background:rgba(255,255,255,0.18);}
        #chatInput::placeholder{color: rgba(255,255,255,0.6);}
        #sendBtn{height:40px;border-radius:8px;width: 60px; position: absolute; top: 0; left: 5px; bottom: 0; margin: auto; background: #2ea6ff; transition:0.2s;} 
        #sendBtn:hover{background:#1e96ef;}
        .redDot{width:10px;height:10px;background:red;border-radius:50%;display:inline-block;margin-left:4px; animation:pulse 1.5s infinite;} 
        .joinLeave{color:#ffa500;font-style:italic; text-align: center; width: 100%; font-size: 12px; animation: slideIn 0.4s ease-out;}
        .normalMsg{text-align: right; color: #fff; background: rgba(255,255,255,0.07); padding: 6px 10px; border-radius: 8px; margin: 4px 0; animation: slideIn 0.3s ease-out;}
        
        /* Animations */
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
        @keyframes floatIn{from{opacity:0;transform:translateY(-20px) scale(0.95);}to{opacity:1;transform:translateY(0) scale(1);}}
        @keyframes slideIn{from{opacity:0;transform:translateX(30px);}to{opacity:1;transform:translateX(0);}}
        @keyframes pulse{0%{opacity:1;}50%{opacity:0.5;}100%{opacity:1;}}
        
        /* حقوق النشر */
        .copyright{position:absolute;bottom:10px;width:100%;text-align:center;font-size:12px;color:rgba(255,255,255,0.5);}
        
        /* responsive small screens */
        @media (max-width:420px){ 
            #floating{width:85%; max-width:300px; height:240px; left: 0; right: 0; margin: 0 auto; top: 10px;} 
            #chatInput{height:36px; font-size:14px;} 
            #sendBtn{height:36px;} 
        }
        
        /* زر الخروج */
        #leaveBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: 50%;
            z-index: 1000;
            cursor: pointer;
            display: none;
        }
        
        /* رسالة تحذير عند محاولة التدوير */
        #orientationWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        
        #orientationWarning h2 {
            color: #ff4444;
            margin-bottom: 20px;
        }
        
        #orientationWarning p {
            margin-bottom: 30px;
            font-size: 18px;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <!-- صفحة الدخول -->
    <div id="loginPage" class="flex center column">
        <h2>مشغل فيديو جماعي</h2>
        <input type="text" id="joinName" placeholder="اسمك">
        <input type="text" id="joinCode" placeholder="كود الغرفة">
        <button id="joinBtn">انضم لغرفة موجودة</button>
        <button id="goCreate">انشاء غرفة جديدة</button>
    </div>

    <!-- صفحة إنشاء غرفة -->
    <div id="createPage" class="flex center column" style="display:none">
        <h2>إنشاء غرفة جديدة</h2>
        <input type="text" id="createName" placeholder="اسمك">
        <input type="text" id="createCode" placeholder="كود الغرفة">
        <input type="text" id="videoUrl" placeholder="رابط الفيديو">
        <button id="createBtn">انشاء غرفة جديدة</button>
        <button id="backLogin">رجوع</button>
        <div class="copyright">Coding by KIMO</div>
    </div>

    <!-- صفحة المشغل -->
    <div id="playerPage">
        <video id="video" controls></video>
        
        <!-- النافذة العائمة للشات -->
        <div id="floating">
            <div id="floatingHeader">
                <div id="floatingTitle">الشات العائم</div>
                <div id="headerBtns">
                    <div class="headerBtn" id="minBtn">_</div>
                </div>
            </div>
            <div id="chatMessages"></div>
            <div id="chatInputContainer">
                <div id="chatRow">
                    <input type="text" id="chatInput" placeholder="اكتب رسالة...">
                    <button id="sendBtn">➤</button>
                </div>
            </div>
        </div>
        
        <!-- زر الخروج -->
        <button id="leaveBtn">خروج</button>
        
        <!-- عنصر الصوت للإشعارات -->
        <audio id="notifySound" preload="auto">
            <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
        </audio>
        
        <!-- رسالة تحذير عند محاولة التدوير -->
        <div id="orientationWarning">
            <h2>⚠️ التدوير غير مدعوم</h2>
            <p>هذا التطبيق لا يدعم الوضع الأفقي. يرجى إبقاء الهاتف في الوضع العمودي.</p>
            <button onclick="document.getElementById('orientationWarning').style.display='none'">موافق</button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"; 
        import { getDatabase, ref, set, push, onChildAdded, onDisconnect, get, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"; 
        
        const firebaseConfig = { 
            apiKey: "AIzaSyDYS0puL52H2XVYOrRLkpm7MSyx-MfpaWM", 
            authDomain: "one-86784.firebaseapp.com", 
            databaseURL: "https://one-86784-default-rtdb.firebaseio.com", 
            projectId: "one-86784", 
            storageBucket: "one-86784.firebasestorage.app", 
            messagingSenderId: "704661926664", 
            appId: "1:704661926664:android:ee692dcb8708fef3a572bd" 
        }; 
        
        const app = initializeApp(firebaseConfig); 
        const db = getDatabase(app); 
        
        // DOM
        const loginPage=document.getElementById('loginPage'); 
        const createPage=document.getElementById('createPage'); 
        const playerPage=document.getElementById('playerPage'); 
        const goCreate=document.getElementById('goCreate'); 
        const backLogin=document.getElementById('backLogin'); 
        const joinName=document.getElementById('joinName'); 
        const joinCode=document.getElementById('joinCode'); 
        const joinBtn=document.getElementById('joinBtn'); 
        const createName=document.getElementById('createName'); 
        const createCode=document.getElementById('createCode'); 
        const videoUrlInput=document.getElementById('videoUrl'); 
        const createBtn=document.getElementById('createBtn'); 
        const video=document.getElementById('video'); 
        const floating=document.getElementById('floating'); 
        const chatMessages=document.getElementById('chatMessages'); 
        const chatInput=document.getElementById('chatInput'); 
        const sendBtn=document.getElementById('sendBtn'); 
        const minBtn=document.getElementById('minBtn'); 
        const leaveBtn=document.getElementById('leaveBtn');
        const notifySound=document.getElementById('notifySound');
        
        let state={name:null,room:null,isMin:false,sound:true,currentTime:0}; 
        let roomRefs = {}; 
        let lastSentTimeUpdate = 0; 
        let lastLocalActionAt = 0; 
        let ignoreNextRemoteUpdate = false;
        const CONTROL_LOCK_MS = 3000;
        const IGNORE_OWN_UPDATE_MS = 2000;
        const TIME_SYNC_THRESHOLD = 1.0;
        
        // منع التدوير والوضع الأفقي
        function lockOrientation() {
            // منع التدوير على الأجهزة المحمولة
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(function(error) {
                    console.log("لم يتم دعم قفل الاتجاه: ", error);
                });
            }
            
            // اكتشاف تغيير الاتجاه وعرض تحذير
            window.addEventListener('orientationchange', function() {
                if (Math.abs(window.orientation) === 90) {
                    document.getElementById('orientationWarning').style.display = 'flex';
                }
            });
            
            // منع تغيير حجم النافذة على سطح المكتب
            window.addEventListener('resize', function() {
                if (window.innerHeight < window.innerWidth) {
                    document.getElementById('orientationWarning').style.display = 'flex';
                }
            });
        }
        
        // التنقل بين الصفحات 
        goCreate.onclick=()=>{
            loginPage.style.display='none'; 
            createPage.style.display='flex'; 
            history.pushState({page:'create'},'');
            document.querySelector('.copyright').style.animation = 'fadeIn 1s ease-out';
        }; 
        
        backLogin.onclick=()=>{
            createPage.style.display='none'; 
            loginPage.style.display='flex';
            document.querySelector('h2').style.animation = 'slideIn 0.5s ease-out';
        }; 
        
        // إنشاء غرفة 
        createBtn.onclick=async()=>{ 
            const name=createName.value.trim(); 
            const room=createCode.value.trim(); 
            const url=videoUrlInput.value.trim(); 
            if(!name||!room||!url){alert("املأ كل الحقول"); return;} 
            
            const roomRef=ref(db, `rooms/${room}`); 
            const snap=await get(roomRef); 
            if(snap.exists()){alert("الغرفة موجودة مسبقًا"); return;} 
            
            await set(roomRef,{ 
                video:url, 
                createdBy:name, 
                currentTime:0, 
                paused:true, 
                lastActionAt:0, 
                lastActionBy:'', 
                controlLock:{by:'',until:0} 
            }); 
            
            state.name=name; 
            state.room=room; 
            startPlayer(url); 
            history.pushState({page:'player'},''); 
        }; 
        
        // الانضمام لغرفة 
        joinBtn.onclick=async()=>{ 
            const name=joinName.value.trim(); 
            const room=joinCode.value.trim(); 
            if(!name||!room){alert("املأ كل الحقول"); return;} 
            
            const roomRef=ref(db, `rooms/${room}`); 
            const snap=await get(roomRef); 
            if(!snap.exists()){alert("الغرفة غير موجودة"); return;} 
            
            const data=snap.val(); 
            state.name=name; 
            state.room=room; 
            startPlayer(data.video); 
            history.pushState({page:'player'},''); 
        }; 
        
        // تشغيل المشغل 
        function startPlayer(url){ 
            loginPage.style.display='none'; 
            createPage.style.display='none'; 
            playerPage.style.display='flex'; 
            video.src=url; 
            video.currentTime=state.currentTime||0; 
            video.pause(); 
            
            // تفعيل قفل الاتجاه
            lockOrientation();
            
            initRoom(); 
            
            // إضافة تأثير عند تحميل الفيديو
            video.style.opacity = '0';
            setTimeout(() => {
                video.style.transition = 'opacity 0.8s ease';
                video.style.opacity = '1';
            }, 100);
        } 
        
        // إعداد الغرفة والشات 
        function initRoom(){ 
            const msgsRef=ref(db, `rooms/${state.room}/messages`); 
            const userRef=ref(db, `rooms/${state.room}/users/${encodeURIComponent(state.name)}`); 
            const roomRef=ref(db, `rooms/${state.room}`); 
            roomRefs = {msgsRef, userRef, roomRef}; 
            
            // سجل دخول المستخدم 
            set(userRef,{joinedAt:Date.now()}); 
            onDisconnect(userRef).remove(); 
            
            // رسالة نظامية للانضمام 
            push(msgsRef,{system:true,text:`${state.name} انضم`,time:Date.now()}); 
            
            // مراقبة تغييرات الغرفة
            onValue(roomRef, snap=>{ 
                const data = snap.val(); 
                if(!data) return; 
                
                if (ignoreNextRemoteUpdate) {
                    ignoreNextRemoteUpdate = false;
                    return;
                }
                
                const now = Date.now(); 
                const lastActionBy = data.lastActionBy || ''; 
                const lastActionAt = data.lastActionAt || 0; 
                const lock = data.controlLock || {by:'',until:0}; 
                
                if(lastActionBy === state.name && (now - lastActionAt) < IGNORE_OWN_UPDATE_MS){ 
                    return; 
                } 
                
                if(lock && lock.by && lock.by !== state.name && now < (lock.until || 0)){ 
                    return; 
                } 
                
                if(typeof data.currentTime === 'number'){ 
                    const remoteTime = data.currentTime; 
                    const localTime = video.currentTime || 0; 
                    if(Math.abs(remoteTime - localTime) > TIME_SYNC_THRESHOLD){ 
                        try{ 
                            video.currentTime = remoteTime; 
                        } catch(e){} 
                    } 
                } 
                
                if(data.paused) { 
                    if(!video.paused) {
                        video.pause();
                        // تأثير عند الإيقاف
                        video.style.filter = 'brightness(0.8)';
                        setTimeout(() => { video.style.filter = 'brightness(1)'; }, 300);
                    }
                } else { 
                    if(video.paused) {
                        video.play().catch(()=>{});
                        // تأثير عند التشغيل
                        video.style.filter = 'brightness(1.2)';
                        setTimeout(() => { video.style.filter = 'brightness(1)'; }, 300);
                    }
                } 
            }); 
            
            // استلام الرسائل 
            onChildAdded(msgsRef,snap=>{ 
                const m=snap.val(); 
                const div=document.createElement('div'); 
                
                if(m.system) {
                    div.classList.add('joinLeave');
                    div.textContent = m.text;
                } else {
                    div.classList.add('normalMsg');
                    div.textContent = m.text;
                }
                
                chatMessages.appendChild(div); 
                chatMessages.scrollTop=chatMessages.scrollHeight; 
                
                if(state.sound && state.isMin) {
                    notifySound.currentTime = 0;
                    notifySound.play().catch(e => console.log("لا يمكن تشغيل الصوت:", e));
                } 
                if(state.isMin) minBtn.innerHTML='<span class="redDot"></span>'; 
            }); 
            
            // حدث الخروج من الصفحة أو الرجوع
            window.addEventListener('beforeunload', handleLeave); 
            window.addEventListener('popstate', handleLeave); 
            
            // زر إرسال 
            sendBtn.onclick = async()=>{ 
                const text = chatInput.value.trim(); 
                if(!text) return; 
                
                // تأثير عند الإرسال
                sendBtn.style.transform = 'scale(0.95)';
                setTimeout(() => { sendBtn.style.transform = 'scale(1)'; }, 150);
                
                await push(msgsRef,{system:false,text:`${state.name}: ${text}`,time:Date.now()}); 
                chatInput.value=''; 
            }; 
            
            // إرسال الرسالة عند الضغط على Enter
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtn.click();
                }
            });
            
            // زر تصغير النافذة 
            minBtn.onclick=toggleMinimize; 
            
            // زر الخروج
            leaveBtn.onclick = handleLeave;
            
            // التحكمات على الفيديو
            video.addEventListener('play', ()=> {
                ignoreNextRemoteUpdate = true;
                localActionSet({paused:false});
            }); 
            
            video.addEventListener('pause', ()=> {
                ignoreNextRemoteUpdate = true;
                localActionSet({paused:true});
            }); 
            
            video.addEventListener('seeking', ()=> { 
                // تأثير أثناء السحب
                video.style.filter = 'contrast(1.2)';
            }); 
            
            video.addEventListener('seeked', ()=> {
                ignoreNextRemoteUpdate = true;
                localActionSet({currentTime: video.currentTime, paused: video.paused});
                video.style.filter = 'contrast(1)';
            }); 
            
            // timeupdate
            video.addEventListener('timeupdate', ()=>{ 
                const now = Date.now(); 
                if(now - lastSentTimeUpdate < 1000) return; 
                lastSentTimeUpdate = now; 
                safeUpdateRoom({ currentTime: video.currentTime }); 
            }); 
        } 
        
        // دالة تساعد على وضع قفل تحكم عندما يقوم المستخدم بإجراء محلي 
        async function localActionSet(payload){ 
            if(!state.room) return; 
            const roomRef = ref(db, `rooms/${state.room}`); 
            const now = Date.now(); 
            lastLocalActionAt = now; 
            
            const lockUntil = now + CONTROL_LOCK_MS; 
            const pushData = { 
                lastActionBy: state.name, 
                lastActionAt: now, 
                controlLock: { by: state.name, until: lockUntil } 
            }; 
            
            if(typeof payload.currentTime === 'number') pushData.currentTime = payload.currentTime; 
            if(typeof payload.paused === 'boolean') pushData.paused = payload.paused; 
            
            try{ 
                await update(roomRef, pushData); 
            }catch(e){} 
        } 
        
        // تحديث آمن بدون قفل
        async function safeUpdateRoom(obj){ 
            if(!state.room) return; 
            const roomRef = ref(db, `rooms/${state.room}`); 
            try{ 
                await update(roomRef, obj); 
            }catch(e){} 
        } 
        
        // زر التصغير/تكبير 
        function toggleMinimize(){ 
            if(!state.isMin){ 
                floating.style.height='44px'; 
                chatMessages.style.display='none'; 
                document.getElementById('chatRow').style.display='none'; 
                state.isMin=true; 
                minBtn.innerHTML='▢'; 
                floating.style.animation = 'floatIn 0.4s ease-out';
            } else { 
                floating.style.height='260px'; 
                chatMessages.style.display='block'; 
                document.getElementById('chatRow').style.display='flex'; 
                state.isMin=false; 
                minBtn.innerHTML='_'; 
                floating.style.animation = 'floatIn 0.4s ease-out';
            } 
        } 
        
        /* سلوك السحب الناعم للنافذة مع تحسين للهاتف */ 
        (function makeDraggable(el){ 
            let dragging=false, startX=0, startY=0, startLeft=0, startTop=0, rafId=null; 
            let targetLeft=0, targetTop=0; 
            
            const getScreenDimensions = () => {
                return {
                    width: window.innerWidth || document.documentElement.clientWidth,
                    height: window.innerHeight || document.documentElement.clientHeight
                };
            };
            
            el.addEventListener('pointerdown', (e)=>{ 
                if(e.target && e.target.closest('#chatInput')) return;
                dragging=true; 
                el.setPointerCapture(e.pointerId); 
                startX = e.clientX; 
                startY = e.clientY; 
                const rect = el.getBoundingClientRect(); 
                startLeft = rect.left; 
                startTop = rect.top; 
                targetLeft = startLeft; 
                targetTop = startTop; 
                document.body.style.userSelect = 'none'; 
                el.style.transition = 'none';
                el.style.boxShadow = '0 0 25px rgba(0,0,0,0.9)';
            }); 
            
            el.addEventListener('pointermove', (e)=>{ 
                if(!dragging) return; 
                const dx = e.clientX - startX; 
                const dy = e.clientY - startY; 
                targetLeft = startLeft + dx; 
                targetTop = startTop + dy; 
                
                const screen = getScreenDimensions();
                const elWidth = el.offsetWidth;
                const elHeight = el.offsetHeight;
                
                targetLeft = Math.max(0, Math.min(targetLeft, screen.width - elWidth));
                targetTop = Math.max(0, Math.min(targetTop, screen.height - elHeight));
                
                if(!rafId){ 
                    rafId = requestAnimationFrame(()=> { 
                        el.style.left = `${targetLeft}px`; 
                        el.style.top = `${targetTop}px`; 
                        rafId = null; 
                    }); 
                } 
            }); 
            
            el.addEventListener('pointerup', (e)=>{ 
                if(!dragging) return; 
                dragging = false; 
                el.releasePointerCapture(e.pointerId); 
                document.body.style.userSelect = ''; 
                el.style.transition = 'box-shadow 0.3s ease, transform 0.2s ease';
                el.style.boxShadow = '0 0 20px rgba(0,0,0,0.8)';
                if(!rafId) cancelAnimationFrame(rafId);
            }); 
            
            el.addEventListener('pointercancel', ()=>{ 
                dragging=false; 
                el.style.transition = '';
                el.style.boxShadow = '0 0 20px rgba(0,0,0,0.8)';
            }); 
        })(floating); 
        
        /* تنظيف وترك الغرفة عند الخروج */ 
        async function handleLeave(){ 
            try{ 
                if(state.room && state.name){ 
                    const userRef = ref(db, `rooms/${state.room}/users/${encodeURIComponent(state.name)}`); 
                    await push(ref(db, `rooms/${state.room}/messages`), {system:true, text:`${state.name} خرج`, time:Date.now()}); 
                    await set(userRef, null); 
                } 
            }catch(e){} 
            
            // تأثير عند المغادرة
            playerPage.style.opacity = '0';
            playerPage.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                loginPage.style.display='flex'; 
                createPage.style.display='none'; 
                playerPage.style.display='none';
                playerPage.style.opacity = '1';
                location.reload();
            }, 500);
        }
    </script>
</body>
</html>
